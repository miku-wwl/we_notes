实现二维码扫码登录通常涉及几个关键技术环节：生成二维码、识别二维码、处理登录逻辑等。以下是一个基本的实现流程，涵盖从前端到后端的整个过程：

### 1. 前端生成二维码

#### 生成二维码

- **生成登录请求**：在用户点击“二维码登录”按钮时，前端向后端发起一个请求，请求生成一个唯一的登录凭据（如 token 或 session id）。
- **获取二维码内容**：后端返回一个包含登录凭据的 URL，该 URL 指向一个特定的回调页面或服务端处理程序。
- **生成二维码图像**：前端使用 JavaScript 库（如 QRCode.js）或服务端生成二维码图像，并显示给用户。

#### 示例代码（前端生成二维码）：

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>二维码登录</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  </head>
  <body>
    <button onclick="generateQRCode()">扫码登录</button>
    <div id="qrcode"></div>

    <script>
      function generateQRCode() {
        fetch("/api/generate-login-token")
          .then((response) => response.json())
          .then((data) => {
            var qrcode = new QRCode(document.getElementById("qrcode"), {
              text: data.qrUrl,
              width: 200,
              height: 200,
            });
          });
      }
    </script>
  </body>
</html>
```

### 2. 后端生成登录凭据

#### 创建登录凭据

- **生成随机字符串**：后端生成一个唯一的随机字符串（如 UUID），作为登录凭据。
- **存储登录凭据**：将登录凭据与用户的会话信息关联存储，例如存储在数据库或内存缓存中，并设置过期时间。
- **返回回调 URL**：返回一个包含登录凭据的 URL，该 URL 指向一个特定的回调页面或服务端处理程序。

#### 示例代码（后端生成登录凭据）：

```java
import java.util.UUID;
import java.time.Duration;
import java.util.concurrent.TimeUnit;

@RestController
@RequestMapping("/api")
public class LoginController {

    @Autowired
    private LoginTokenService loginTokenService;

    @GetMapping("/generate-login-token")
    public ResponseEntity<LoginTokenResponse> generateLoginToken() {
        String token = UUID.randomUUID().toString();
        String qrUrl = "http://yourapp.com/callback?token=" + token;

        // 存储登录凭据
        loginTokenService.storeToken(token, Duration.ofMinutes(5));

        return ResponseEntity.ok(new LoginTokenResponse(qrUrl));
    }
}

// 登录凭据服务
@Service
public class LoginTokenService {

    private final Cache<String, String> tokenCache;

    public LoginTokenService(CacheManager cacheManager) {
        tokenCache = cacheManager.getCache("loginTokens");
    }

    public void storeToken(String token, Duration duration) {
        tokenCache.put(token, token, duration.toMillis(), TimeUnit.MILLISECONDS);
    }
}

// 响应实体类
class LoginTokenResponse {
    private String qrUrl;

    public LoginTokenResponse(String qrUrl) {
        this.qrUrl = qrUrl;
    }

    public String getQrUrl() {
        return qrUrl;
    }
}
```

### 3. 扫码识别二维码

- **扫码设备**：用户使用手机或其他扫码设备扫描二维码。
- **识别登录凭据**：扫码设备识别二维码中的 URL，并跳转到该 URL 对应的页面或服务端处理程序。

### 4. 登录逻辑处理

#### 处理登录请求

- **接收登录请求**：服务端接收到包含登录凭据的请求。
- **验证登录凭据**：验证登录凭据是否有效，并与用户账户关联。
- **登录成功**：如果验证成功，服务端创建一个新的会话，并返回登录成功的响应。

#### 示例代码（后端处理登录请求）：

```java
@GetMapping("/callback")
public ResponseEntity<LoginResponse> handleCallback(@RequestParam("token") String token) {
    if (loginTokenService.isValidToken(token)) {
        // 创建会话并返回登录成功的响应
        String sessionId = createSession();
        return ResponseEntity.ok(new LoginResponse(sessionId));
    } else {
        return ResponseEntity.badRequest().build();
    }
}

// 创建会话
private String createSession() {
    // 生成会话ID并存储会话信息
    String sessionId = UUID.randomUUID().toString();
    // 存储会话信息
    sessionService.createSession(sessionId);
    return sessionId;
}
```

### 5. 前端处理登录响应

- **接收登录响应**：前端监听扫码设备的回调请求，并接收服务端返回的登录成功响应。
- **跳转或显示登录状态**：根据登录响应的内容，前端可以跳转到用户的主页或显示登录成功的状态。

### 总结

实现二维码扫码登录需要前后端协同工作，前端负责生成和展示二维码，后端负责生成和验证登录凭据。通过合理的接口设计和状态管理，可以实现一个安全、高效的二维码扫码登录流程。
